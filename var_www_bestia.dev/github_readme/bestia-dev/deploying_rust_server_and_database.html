<!DOCTYPE html>
<html>

<head>
    <title>deploying_rust_server_and_database</title>
    <meta http-equiv="Content-type" content="text/html;charset=utf-8" />
    <meta name="Description" content="06. Tutorial on how to deploy Rust Web Server and Database (deploying_rust_server_and_database) (2022-08)">
    <meta name="author" content="https://github.com/bestia-dev">
    <meta name=viewport content="width=device-width, initial-scale=1">
    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico">
    <link rel="stylesheet" href="../css/normalize.css">
    <link rel="stylesheet" href="../css/bestia01.css">
    <script>
        /* Toggle between adding and removing the "responsive" class to navbar when the user clicks on the hamburger */
        function toggle_responsive_navbar() {
            var x = document.getElementById("navbar");
            if (x.className.includes(" responsive")) {
                x.className = x.className.replace(" responsive", "");
            } else {
                x.className += " responsive";
            }
        }
    </script>
</head>

<body>
    <div class="fixed_header">
        <div id="navbar">
            <a id="navbar_brand" href="https://bestia.dev">
                <img src="bestia_icon.png" alt="Bestia development" title="bestia.dev" />
                <span id="navbar_title"> Bestia dev</span>
            </a>
            <a id="navbar_hamburger" href="javascript:void(0);" onclick="toggle_responsive_navbar()">☰ </a>
            <div id="navbar_topics">
                <a href="/index.html#home" onclick="toggle_responsive_navbar()">Home </a>
                <a href="/index.html#tutorials" onclick="toggle_responsive_navbar()">Tutorials</a>
                <a href="/index.html#games" onclick="toggle_responsive_navbar()">Games</a>
                <a href="/index.html#productivity" onclick="toggle_responsive_navbar()">Productivity</a>
                <a href="/index.html#contact" onclick="toggle_responsive_navbar()">Contact</a>
            </div>
        </div>
    </div>
    <div>&nbsp;</div> 
    <div class="small">This is a copy of the Github readme.<br/>
    Find the original on <a href="https://github.com/bestia-dev/deploying_rust_server_and_database">https://github.com/bestia-dev/deploying_rust_server_and_database</a></div>

<article class="markdown-body entry-content container-lg" itemprop="text">
<div class="markdown-heading" dir="auto"><h1 tabindex="-1" class="heading-element" dir="auto">deploying_rust_server_and_database</h1><a id="user-content-deploying_rust_server_and_database" class="anchor" aria-label="Permalink: deploying_rust_server_and_database" href="#deploying_rust_server_and_database"></a></div>
<p dir="auto"><strong>06. Tutorial on how to deploy Rust Web Server and Database (deploying_rust_server_and_database) (2022-08)</strong><br>
<em><strong>version: 1.0  date: 2022-08-12 author: <a href="https://bestia.dev" rel="nofollow">bestia.dev</a> repository: <a href="https://github.com/bestia-dev/deploying_rust_server_and_database">GitHub</a></strong></em></p>
<p dir="auto"><a target="_blank" rel="noopener noreferrer nofollow" href="https://camo.githubusercontent.com/e8100395d149fab3d02c3ee4672d2cc5d833bf4ab9044e6c57f47c54baf4d1ba/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f6d61696e7461696e65642d677265656e"><img src="https://img.shields.io/badge/maintained-green" alt="maintained" style="max-width: 100%;"></a>
<a target="_blank" rel="noopener noreferrer nofollow" href="https://camo.githubusercontent.com/3d28e085cfc1f662a567e40863593879fb9896391cde406b9ff5775277affe41/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f72656164795f666f725f7573652d677265656e"><img src="https://img.shields.io/badge/ready_for_use-green" alt="ready_for_use" style="max-width: 100%;"></a>
<a target="_blank" rel="noopener noreferrer nofollow" href="https://camo.githubusercontent.com/c273959e453b2eacb9b7719663be397499b129c79eb13180305a069b3c2f5e51/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f7475746f7269616c2d79656c6c6f77"><img src="https://img.shields.io/badge/tutorial-yellow" alt="tutorial" style="max-width: 100%;"></a>
<a target="_blank" rel="noopener noreferrer nofollow" href="https://camo.githubusercontent.com/7dc68eddf068bbfac81788618cabfa4200826f2ce816cb801a450385807d1131/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f796f75747562652d79656c6c6f77"><img src="https://img.shields.io/badge/youtube-yellow" alt="youtube" style="max-width: 100%;"></a></p>
<p dir="auto"><a href="https://github.com/bestia-dev/deploying_rust_server_and_database/"><img src="https://img.shields.io/badge/Lines_in_markdown-401-green.svg" alt="Lines in md" style="max-width: 100%;"></a>
<a href="https://github.com/bestia-dev/deploying_rust_server_and_database/"><img src="https://img.shields.io/badge/Lines_in_bash_scripts-190-blue.svg" alt="Lines in bash scripts" style="max-width: 100%;"></a></p>
<p dir="auto"><a href="https://github.com/bestia-dev/deploying_rust_server_and_database/blob/master/LICENSE"><img src="https://img.shields.io/badge/license-MIT-blue.svg" alt="License" style="max-width: 100%;"></a>
<a target="_blank" rel="noopener noreferrer nofollow" href="https://camo.githubusercontent.com/4c199a4a7df38726a9881f3113ffa4e1ba7191ae2521d6aabc25134ae84325d3/68747470733a2f2f6265737469612e6465762f776562706167655f6869745f636f756e7465722f6765745f7376675f696d6167652f3532393433333633322e737667"><img src="https://bestia.dev/webpage_hit_counter/get_svg_image/529433632.svg" alt="deploying_rust_server_and_database" style="max-width: 100%;"></a></p>
<p dir="auto">Hashtags: #rustlang #buildtool #developmenttool #tutorial #docker #ssh<br>
My projects on Github are more like a tutorial than a finished product: <a href="https://github.com/bestia-dev/tutorials_rust_wasm">bestia-dev tutorials</a>.</p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">Intro</h2><a id="user-content-intro" class="anchor" aria-label="Permalink: Intro" href="#intro"></a></div>
<p dir="auto">Welcome to bestia.dev !<br>
Learning Rust and Wasm programming and having fun.<br>
I just love  programming !</p>
<p dir="auto">In my <a href="https://bestia.dev/youtube/sort_text_international_rust_wasm_pwa.html" rel="nofollow">fifth tutorial</a> of the series <a href="https://www.youtube.com/playlist?list=PLbXDHfG-c3U8pkyN1D7SwF3ItA3uTyoWW" rel="nofollow">"bestia.dev Tutorials for Rust programming language",</a> I created a simple web application "webpage_hit_counter".
It works fine on my local <a href="https://bestia.dev/youtube/win10_wsl2_debian11.html" rel="nofollow">Rust development environment inside a docker container</a>.
Now I want to deploy it to the Cloud.<br>
The code for deployment is part of the <a href="https://github.com/bestia-dev/webpage_hit_counter">webpage_hit_counter</a> project.</p>
<p dir="auto">This project has also a youtube video tutorial. Watch it:</p>

<p dir="auto"><a href="https://bestia.dev/youtube/deploying_rust_server_and_database.html" rel="nofollow"><img src="https://bestia.dev/youtube/deploying_rust_server_and_database.jpg" width="400px" style="max-width: 100%;"></a></p>

<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">Google Cloud VM free tier</h2><a id="user-content-google-cloud-vm-free-tier" class="anchor" aria-label="Permalink: Google Cloud VM free tier" href="#google-cloud-vm-free-tier"></a></div>
<p dir="auto">I have one VM Engine on GoogleCloud. It is really small, but unbeatably cheap - free tier.<br>
<a href="https://cloud.google.com/free" rel="nofollow">https://cloud.google.com/free</a><br>
Services included in the free tier us-west1-b (Oregon):</p>
<ul dir="auto">
<li>Compute engine E2-micro core (before discount 3.85€)<br>
E2 shared-core machines have fractional vCPUs - 25% of one CPU core</li>
<li>E2 ram (before discount 2.06€)</li>
<li>Total 0.00€</li>
</ul>
<p dir="auto">I access the VM over SSH from my WSL Debian bash terminal.<br>
Then it opens the Linux bash terminal of the VM where I manage everything.<br>
No GUI is needed. It is just a server!</p>
<p dir="auto">Run ssh to connect to the Google VM bash in my terminal:</p>
<div class="highlight highlight-source-shell notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="ssh -i ~/.ssh/ssh_certificate username@domain -v"><pre>ssh -i <span class="pl-k">~</span>/.ssh/ssh_certificate username@domain -v</pre></div>
<p dir="auto">Debian version:</p>
<div class="highlight highlight-source-shell notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="lsb_release -a
   11 bullseye  "><pre>lsb_release -a
   11 bullseye  </pre></div>
<p dir="auto">Update and upgrade:</p>
<div class="highlight highlight-source-shell notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="sudo apt -y update &amp;&amp; sudo apt -y upgrade"><pre>sudo apt -y update <span class="pl-k">&amp;&amp;</span> sudo apt -y upgrade</pre></div>
<p dir="auto">maybe I need to reboot? No need. Good.<br>
How much space do I have on my limited small VM disk 10 GB?</p>
<div class="highlight highlight-source-shell notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="df -h
   /dev/sda1       9.8G  6.1G  3.2G  66% /"><pre>df -h
   /dev/sda1       9.8G  6.1G  3.2G  66% /</pre></div>
<p dir="auto">Clean some space:</p>
<div class="highlight highlight-source-shell notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="sudo apt-get clean"><pre>sudo apt-get clean</pre></div>
<p dir="auto">Now I have a little more space:</p>
<div class="highlight highlight-source-shell notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="df -h
   /dev/sda1       9.8G  5.4G  3.9G  58% /"><pre>df -h
   /dev/sda1       9.8G  5.4G  3.9G  58% /</pre></div>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">Uninstall docker</h2><a id="user-content-uninstall-docker" class="anchor" aria-label="Permalink: Uninstall docker" href="#uninstall-docker"></a></div>
<p dir="auto">I will uninstall docker because I will use Podman instead. Podman is an in-place replacement for Docker. It is not a service, just a simple executable.<br>
<a href="https://podman.io/" rel="nofollow">https://podman.io/</a><br>
On my VM I didn't really use any containers before, I was just experimenting with docker, so I don't care if I delete everything: images, containers, volumes,...</p>
<div class="highlight highlight-source-shell notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="dpkg -l | grep -i docker
sudo apt-get purge -y docker-engine docker docker.io docker-ce docker-ce-cli
sudo apt-get autoremove -y --purge docker-engine docker docker.io docker-ce  
sudo rm -rf /var/lib/docker /etc/docker
sudo rm /etc/apparmor.d/docker
sudo groupdel docker
sudo rm -rf /var/run/docker.sock
df -h
   /dev/sda1       9.8G  5.0G  4.3G  54% /"><pre>dpkg -l <span class="pl-k">|</span> grep -i docker
sudo apt-get purge -y docker-engine docker docker.io docker-ce docker-ce-cli
sudo apt-get autoremove -y --purge docker-engine docker docker.io docker-ce  
sudo rm -rf /var/lib/docker /etc/docker
sudo rm /etc/apparmor.d/docker
sudo groupdel docker
sudo rm -rf /var/run/docker.sock
df -h
   /dev/sda1       9.8G  5.0G  4.3G  54% /</pre></div>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">Install Podman</h2><a id="user-content-install-podman" class="anchor" aria-label="Permalink: Install Podman" href="#install-podman"></a></div>
<p dir="auto">Installing Podman is super easy on Debian 11.</p>
<div class="highlight highlight-source-shell notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="sudo apt install podman  

podman --version
   podman version 3.0.1
df -h
   /dev/sda1       9.8G  5.1G  4.2G  56% /"><pre>sudo apt install podman  

podman --version
   podman version 3.0.1
df -h
   /dev/sda1       9.8G  5.1G  4.2G  56% /</pre></div>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">Pull and run the Postgres container</h2><a id="user-content-pull-and-run-the-postgres-container" class="anchor" aria-label="Permalink: Pull and run the Postgres container" href="#pull-and-run-the-postgres-container"></a></div>
<p dir="auto">For now, we will not deep dive into security. We will do that later.<br>
We need a local directory to persist the data of the Postgres server. It is not good to have the data inside the container. Then the data will be deleted if the container is removed. And that will happen eventually. Containers are ephemeral, they can be deleted at any time.<br>
<a href="https://techviewleo.com/how-to-run-postgresql-in-podman-container/" rel="nofollow">https://techviewleo.com/how-to-run-postgresql-in-podman-container/</a></p>
<div class="highlight highlight-source-shell notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="mkdir -p /home/luciano_bestia/postgres_data/webpage_hit_counter_pod

podman pull docker.io/library/postgres:13

podman run --name postgresql -d \
  -e POSTGRES_USER=admin \
  -e POSTGRES_PASSWORD=Passw0rd \
  -p 5432:5432 \
  -v /home/luciano_bestia/postgres_data/webpage_hit_counter_pod:/var/lib/postgresql/data \
  docker.io/library/postgres:13

podman ps
   CONTAINER ID  IMAGE                          COMMAND   CREATED       STATUS           PORTS                   NAMES
   24ff633d6004  docker.io/library/postgres:13  postgres  19 hours ago  Up 19 hours ago  0.0.0.0:5432-&gt;5432/tcp  postgresql
df -h
   /dev/sda1       9.8G  5.6G  3.8G  60% /
podman logs postgresql
   2022-08-11 13:48:31.304 UTC [1] LOG:  database system is ready to accept connections"><pre>mkdir -p /home/luciano_bestia/postgres_data/webpage_hit_counter_pod

podman pull docker.io/library/postgres:13

podman run --name postgresql -d \
  -e POSTGRES_USER=admin \
  -e POSTGRES_PASSWORD=Passw0rd \
  -p 5432:5432 \
  -v /home/luciano_bestia/postgres_data/webpage_hit_counter_pod:/var/lib/postgresql/data \
  docker.io/library/postgres:13

podman ps
   CONTAINER ID  IMAGE                          COMMAND   CREATED       STATUS           PORTS                   NAMES
   24ff633d6004  docker.io/library/postgres:13  postgres  19 hours ago  Up 19 hours ago  0.0.0.0:5432-<span class="pl-k">&gt;</span>5432/tcp  postgresql
df -h
   /dev/sda1       9.8G  5.6G  3.8G  60% /
podman logs postgresql
   2022-08-11 13:48:31.304 UTC [1] LOG:  database system is ready to accept connections</pre></div>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">Install psql client</h2><a id="user-content-install-psql-client" class="anchor" aria-label="Permalink: Install psql client" href="#install-psql-client"></a></div>
<p dir="auto">I will install the psql utility to work with the Postgres server.</p>
<div class="highlight highlight-source-shell notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="sudo apt install -y postgresql-client
psql --version
   psql (PostgreSQL) 13.7 (Debian 13.7-0+deb11u1)

#Connect to the postgres server in the container:
psql -h localhost -p 5432 -U admin -W
   Password: ***

#In psql list of databases:  
\l
#Change active database
\c
#List of tables
\dt
#Quit the psql
\q"><pre>sudo apt install -y postgresql-client
psql --version
   psql (PostgreSQL) 13.7 (Debian 13.7-0+deb11u1)

<span class="pl-c"><span class="pl-c">#</span>Connect to the postgres server in the container:</span>
psql -h localhost -p 5432 -U admin -W
   Password: <span class="pl-k">***</span>

<span class="pl-c"><span class="pl-c">#</span>In psql list of databases:  </span>
<span class="pl-cce">\l</span>
<span class="pl-c"><span class="pl-c">#</span>Change active database</span>
<span class="pl-cce">\c</span>
<span class="pl-c"><span class="pl-c">#</span>List of tables</span>
<span class="pl-cce">\d</span>t
<span class="pl-c"><span class="pl-c">#</span>Quit the psql</span>
<span class="pl-cce">\q</span></pre></div>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">Backup and restore database</h2><a id="user-content-backup-and-restore-database" class="anchor" aria-label="Permalink: Backup and restore database" href="#backup-and-restore-database"></a></div>
<p dir="auto">I will back up the database on my development Postgres server and restore it on the VM.<br>
This is a skill every database developer must know.<br>
In the VSCode terminal of the project webpage_hit_counter run:</p>
<div class="highlight highlight-source-shell notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="pg_dump -F t -U admin -h localhost webpage_hit_counter &gt; deploy/webpage_hit_counter_backup.tar
ls -l deploy
   12K webpage_hit_counter_backup.tar


#I can use ssh and sync to copy the file to the server:
rsync -e ssh -a --info=progress2 deploy/webpage_hit_counter_backup.tar luciano_bestia@bestia.dev:/var/www/transfer_folder/webpage_hit_counter/"><pre>pg_dump -F t -U admin -h localhost webpage_hit_counter <span class="pl-k">&gt;</span> deploy/webpage_hit_counter_backup.tar
ls -l deploy
   12K webpage_hit_counter_backup.tar


<span class="pl-c"><span class="pl-c">#</span>I can use ssh and sync to copy the file to the server:</span>
rsync -e ssh -a --info=progress2 deploy/webpage_hit_counter_backup.tar luciano_bestia@bestia.dev:/var/www/transfer_folder/webpage_hit_counter/</pre></div>
<p dir="auto">Now on the VM server, I need to restore it:</p>
<div class="highlight highlight-source-shell notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="cd /var/www/transfer_folder/webpage_hit_counter
pg_restore -C -v -d postgres -U admin -h localhost ./webpage_hit_counter_backup.tar

#Try it:
psql -h localhost -p 5432 -U admin -W -d webpage_hit_counter
#In psql list of databases:  
\l
    webpage_hit_counter | admin | UTF8     | en_US.utf8 | en_US.utf8 |

select * from webpage;
      id   | webpage
    --------+---------
    555555 | test
    777777 | test2
    (2 rows)

#We can check, that the data is stored outside the container:
sudo ls -l ~/postgres_data/webpage_hit_counter_pod"><pre><span class="pl-c1">cd</span> /var/www/transfer_folder/webpage_hit_counter
pg_restore -C -v -d postgres -U admin -h localhost ./webpage_hit_counter_backup.tar

<span class="pl-c"><span class="pl-c">#</span>Try it:</span>
psql -h localhost -p 5432 -U admin -W -d webpage_hit_counter
<span class="pl-c"><span class="pl-c">#</span>In psql list of databases:  </span>
<span class="pl-cce">\l</span>
    webpage_hit_counter <span class="pl-k">|</span> admin <span class="pl-k">|</span> UTF8     <span class="pl-k">|</span> en_US.utf8 <span class="pl-k">|</span> en_US.utf8 <span class="pl-k">|</span>

<span class="pl-k">select</span> <span class="pl-smi">*</span> from webpage<span class="pl-k">;</span>
      id   <span class="pl-k">|</span> webpage
    --------+---------
    555555 <span class="pl-k">|</span> <span class="pl-c1">test</span>
    777777 <span class="pl-k">|</span> test2
    (2 rows)

<span class="pl-c"><span class="pl-c">#</span>We can check, that the data is stored outside the container:</span>
sudo ls -l <span class="pl-k">~</span>/postgres_data/webpage_hit_counter_pod</pre></div>
<p dir="auto">Excellent!</p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">Delete the container</h2><a id="user-content-delete-the-container" class="anchor" aria-label="Permalink: Delete the container" href="#delete-the-container"></a></div>
<p dir="auto">We will not use this Postgres container. It was only for testing. We will create a new pod with a new container.<br>
We can remove this container now. The data will persist on the system disk.</p>
<div class="highlight highlight-source-shell notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="podman ps

podman rm -f postgresql"><pre>podman ps

podman rm -f postgresql</pre></div>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">Deploy the Rust web server</h2><a id="user-content-deploy-the-rust-web-server" class="anchor" aria-label="Permalink: Deploy the Rust web server" href="#deploy-the-rust-web-server"></a></div>
<p dir="auto">I have many small and simple web applications on my Google VM.<br>
Now that I have Podman installed, I will put the webpage_hit_counter application in a container. I want to isolate the applications.<br>
From my Rust development container, I will upload a few files to my Google VM in the folder <code>/var/www/transfer_folder</code>.<br>
There I will run the bash script to create the container image <code>sh buildah_image_webpage_hit_counter.sh</code>.<br>
I will create the container image with <code>buildah</code>. This is the Podman utility for creating images.
The binary executable file <code>target/release/webpage_hit_counter</code> and the dotenv file must be in the same directory where the bash script is run.<br>
Note that the size of the binary can vary enormously. In build debug mode it is 135MB, in build release mode is 10MB. On that, I use the <code>strip</code> command and it is now 5MB in size.<br>
I upload files to my Google VM using rsync and SSH. I coded this in the automation task <code>cargo auto publish_to_web</code> of the project <code>webpage_hit_counter</code>.</p>
<div class="highlight highlight-source-wsd notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="@startuml
[psql]
artifact &quot;pod webpage_hit_counter_pod&quot;{
  frame &quot;container webpage_hit_counter_cnt&quot; {
    [webapp webpage_hit_counter]
  }
  frame &quot;container postgres&quot;{
    database postgres
  }
 [webapp webpage_hit_counter] -&gt; postgres : 5432
}
cloud browser
folder &quot;folder postgres_data&quot;

postgres &lt;-- psql :5432
[webapp webpage_hit_counter] &lt;-- browser : 8080:8011
postgres -&gt; [folder postgres_data]: persistent volume
@enduml"><pre><span class="pl-k">@startuml</span>
[<span class="pl-c1">psql</span>]
<span class="pl-k">artifact</span> <span class="pl-s">"pod webpage_hit_counter_pod"</span>{
<span class="pl-k">  frame</span> <span class="pl-s">"container webpage_hit_counter_cnt"</span> {
    [<span class="pl-c1">webapp</span> <span class="pl-c1">webpage_hit_counter</span>]
  }
<span class="pl-k">  frame</span> <span class="pl-s">"container postgres"</span>{
<span class="pl-k">    database</span> <span class="pl-c1">postgres</span>
  }
 [<span class="pl-c1">webapp</span> <span class="pl-c1">webpage_hit_counter</span>] <span class="pl-k">-&gt;</span> <span class="pl-c1">postgres</span> : 5432
}
<span class="pl-k">cloud</span> <span class="pl-c1">browser</span>
<span class="pl-k">folder</span> <span class="pl-s">"folder postgres_data"</span>

<span class="pl-c1">postgres</span> <span class="pl-k">&lt;--</span> <span class="pl-c1">psql</span> :5432
[<span class="pl-c1">webapp</span> <span class="pl-c1">webpage_hit_counter</span>] <span class="pl-k">&lt;--</span> <span class="pl-c1">browser</span> : 8080:8011
<span class="pl-c1">postgres</span> <span class="pl-k">-&gt;</span> [<span class="pl-c1">folder</span> <span class="pl-c1">postgres_data</span>]: persistent volume
<span class="pl-k">@enduml</span></pre></div>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/bestia-dev/deploying_rust_server_and_database/raw/main/images/pod_uml.png"><img src="https://github.com/bestia-dev/deploying_rust_server_and_database/raw/main/images/pod_uml.png" alt="pod uml" style="max-width: 100%;"></a></p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">create Podman image and pod</h2><a id="user-content-create-podman-image-and-pod" class="anchor" aria-label="Permalink: create Podman image and pod" href="#create-podman-image-and-pod"></a></div>
<p dir="auto">We can now connect the terminal to my Google VM bash over SSH:</p>
<div class="highlight highlight-source-shell notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="ssh -i ~/.ssh/ssh_certificate username@domain -v"><pre>ssh -i <span class="pl-k">~</span>/.ssh/ssh_certificate username@domain -v</pre></div>
<p dir="auto">Run the bash script to create the image:</p>
<div class="highlight highlight-source-shell notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="cd /var/www/transfer_folder/webpage_hit_counter
sh buildah_image_webpage_hit_counter.sh

podman images
   REPOSITORY                                   TAG         IMAGE ID      CREATED       SIZE
   localhost/webpage_hit_counter_img  2022-08-09  7b24309a1205  25 hours ago  110 MB
   docker.io/library/postgres                   13          2990fc2bd747  9 days ago    381 MB"><pre><span class="pl-c1">cd</span> /var/www/transfer_folder/webpage_hit_counter
sh buildah_image_webpage_hit_counter.sh

podman images
   REPOSITORY                                   TAG         IMAGE ID      CREATED       SIZE
   localhost/webpage_hit_counter_img  2022-08-09  7b24309a1205  25 hours ago  110 MB
   docker.io/library/postgres                   13          2990fc2bd747  9 days ago    381 MB</pre></div>
<p dir="auto">Now create and run the pod. This will also run the web app.</p>
<div class="highlight highlight-source-shell notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="sh webpage_hit_counter_pod_create.sh

podman pod ls
   POD ID        NAME                     STATUS    CREATED       INFRA ID      # OF CONTAINERS
   54e7fff2c232  webpage_hit_counter_pod  Running   1 minute ago  e279afe30b48  3"><pre>sh webpage_hit_counter_pod_create.sh

podman pod ls
   POD ID        NAME                     STATUS    CREATED       INFRA ID      <span class="pl-c"><span class="pl-c">#</span> OF CONTAINERS</span>
   54e7fff2c232  webpage_hit_counter_pod  Running   1 minute ago  e279afe30b48  3</pre></div>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">Check the Postgres server</h2><a id="user-content-check-the-postgres-server" class="anchor" aria-label="Permalink: Check the Postgres server" href="#check-the-postgres-server"></a></div>
<p dir="auto">Check the Postgres server with psql:</p>
<div class="highlight highlight-source-shell notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="psql -h localhost -p 5432 -U admin -W -d webpage_hit_counter

#List the databases
\l
   webpage_hit_counter | admin | UTF8     | en_US.utf8 | en_US.utf8 |

select * from webpage;
      id   | webpage
   --------+---------
   555555 | test
   777777 | test2
   (2 rows)

select * from hit_counter;
   id | webpage_id | count
   ----+------------+-------
   4 |     777777 |    35
   1 |     555555 |    29
   (2 rows)"><pre>psql -h localhost -p 5432 -U admin -W -d webpage_hit_counter

<span class="pl-c"><span class="pl-c">#</span>List the databases</span>
<span class="pl-cce">\l</span>
   webpage_hit_counter <span class="pl-k">|</span> admin <span class="pl-k">|</span> UTF8     <span class="pl-k">|</span> en_US.utf8 <span class="pl-k">|</span> en_US.utf8 <span class="pl-k">|</span>

<span class="pl-k">select</span> <span class="pl-smi">*</span> from webpage<span class="pl-k">;</span>
      id   <span class="pl-k">|</span> webpage
   --------+---------
   555555 <span class="pl-k">|</span> <span class="pl-c1">test</span>
   777777 <span class="pl-k">|</span> test2
   (2 rows)

<span class="pl-k">select</span> <span class="pl-smi">*</span> from hit_counter<span class="pl-k">;</span>
   id <span class="pl-k">|</span> webpage_id <span class="pl-k">|</span> count
   ----+------------+-------
   4 <span class="pl-k">|</span>     777777 <span class="pl-k">|</span>    35
   1 <span class="pl-k">|</span>     555555 <span class="pl-k">|</span>    29
   (2 rows)</pre></div>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">check the web application container</h2><a id="user-content-check-the-web-application-container" class="anchor" aria-label="Permalink: check the web application container" href="#check-the-web-application-container"></a></div>
<p dir="auto">The bash script already started the web application in detached mode.</p>
<p dir="auto">We can see the std output with:</p>
<div class="highlight highlight-source-shell notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="podman logs webpage_hit_counter_cnt"><pre>podman logs webpage_hit_counter_cnt</pre></div>
<p dir="auto">The application listens to port 8080, but this port is already in use on my Google VM. Containers can easily forward ports, so we can easily change the port to 8011.</p>
<div class="highlight highlight-source-shell notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="curl http://localhost:8011/webpage_hit_counter/get_svg_image/555555.svg"><pre>curl http://localhost:8011/webpage_hit_counter/get_svg_image/555555.svg</pre></div>
<p dir="auto">It works!</p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">Repetition is the mother of learning</h2><a id="user-content-repetition-is-the-mother-of-learning" class="anchor" aria-label="Permalink: Repetition is the mother of learning" href="#repetition-is-the-mother-of-learning"></a></div>
<p dir="auto">Now that everything is configured it is very easy to deploy any web server plus database application.</p>
<p dir="auto">In VSCode, terminal of project webpage_hit_counter<br>
Build a new release <code>cargo auto release</code>.<br>
Publish to web <code>cargo auto publish_to_web</code>.</p>
<p dir="auto">On the Google VM bash terminal:</p>
<div class="highlight highlight-source-shell notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="#remove pod
podman pod rm -f webpage_hit_counter_pod
cd /var/www/transfer_folder/webpage_hit_counter
#create container image
sh buildah_image_webpage_hit_counter.sh
#create and run the pod
sh webpage_hit_counter_pod_create.sh
#test
curl http://localhost:8011/webpage_hit_counter/get_svg_image/555555.svg"><pre><span class="pl-c"><span class="pl-c">#</span>remove pod</span>
podman pod rm -f webpage_hit_counter_pod
<span class="pl-c1">cd</span> /var/www/transfer_folder/webpage_hit_counter
<span class="pl-c"><span class="pl-c">#</span>create container image</span>
sh buildah_image_webpage_hit_counter.sh
<span class="pl-c"><span class="pl-c">#</span>create and run the pod</span>
sh webpage_hit_counter_pod_create.sh
<span class="pl-c"><span class="pl-c">#</span>test</span>
curl http://localhost:8011/webpage_hit_counter/get_svg_image/555555.svg</pre></div>
<p dir="auto">Done! It works!</p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">Nginx reverse proxy</h2><a id="user-content-nginx-reverse-proxy" class="anchor" aria-label="Permalink: Nginx reverse proxy" href="#nginx-reverse-proxy"></a></div>
<p dir="auto">On my public IP address, I attached the Nginx server. I use it as a reverse proxy.<br>
It receives requests on the https port 443 and then routes them internally to my web apps.<br>
I have many web apps, each one is listening on a different port on localhost.<br>
If the route starts with <code>/webpage_hit_counter/</code> then the Nginx will process it and turn it into a <code>localhost:8011</code> request.</p>
<div class="highlight highlight-source-wsd notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="@startuml

[browser1]
[browser2]
[browser3]

component nginx_reverse_proxy{
  [mem1-&gt;8081]
  [mem2-&gt;8082]
  [webpage_hit_counter-&gt;8011]
}

[webapp1_mem1]
[webapp2_mem2]
[webapp3_webpage_hit_counter]

browser1 --&gt; [mem1-&gt;8081] : /mem1/
browser2 --&gt; [mem2-&gt;8082] : /mem2/
browser3 --&gt; [webpage_hit_counter-&gt;8011] : /webpage_hit_counter/

[mem1-&gt;8081] --&gt; webapp1_mem1 : 8081
[mem2-&gt;8082] --&gt; webapp2_mem2 : 8082
[webpage_hit_counter-&gt;8011] --&gt; webapp3_webpage_hit_counter: 8011

@enduml"><pre><span class="pl-k">@startuml</span>

[<span class="pl-c1">browser1</span>]
[<span class="pl-c1">browser2</span>]
[<span class="pl-c1">browser3</span>]

<span class="pl-k">component</span> <span class="pl-c1">nginx_reverse_proxy</span>{
  [<span class="pl-c1">mem1</span><span class="pl-k">-&gt;</span><span class="pl-c1">8081</span>]
  [<span class="pl-c1">mem2</span><span class="pl-k">-&gt;</span><span class="pl-c1">8082</span>]
  [<span class="pl-c1">webpage_hit_counter</span><span class="pl-k">-&gt;</span><span class="pl-c1">8011</span>]
}

[<span class="pl-c1">webapp1_mem1</span>]
[<span class="pl-c1">webapp2_mem2</span>]
[<span class="pl-c1">webapp3_webpage_hit_counter</span>]

<span class="pl-c1">browser1</span> <span class="pl-k">--&gt;</span> [<span class="pl-c1">mem1</span><span class="pl-k">-&gt;</span><span class="pl-c1">8081</span>] : /mem1/
<span class="pl-c1">browser2</span> <span class="pl-k">--&gt;</span> [<span class="pl-c1">mem2</span><span class="pl-k">-&gt;</span><span class="pl-c1">8082</span>] : /mem2/
<span class="pl-c1">browser3</span> <span class="pl-k">--&gt;</span> [<span class="pl-c1">webpage_hit_counter</span><span class="pl-k">-&gt;</span><span class="pl-c1">8011</span>] : /webpage_hit_counter/

[<span class="pl-c1">mem1</span><span class="pl-k">-&gt;</span><span class="pl-c1">8081</span>] <span class="pl-k">--&gt;</span> <span class="pl-c1">webapp1_mem1</span> : 8081
[<span class="pl-c1">mem2</span><span class="pl-k">-&gt;</span><span class="pl-c1">8082</span>] <span class="pl-k">--&gt;</span> <span class="pl-c1">webapp2_mem2</span> : 8082
[<span class="pl-c1">webpage_hit_counter</span><span class="pl-k">-&gt;</span><span class="pl-c1">8011</span>] <span class="pl-k">--&gt;</span> <span class="pl-c1">webapp3_webpage_hit_counter</span>: 8011

<span class="pl-k">@enduml</span></pre></div>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/bestia-dev/deploying_rust_server_and_database/raw/main/images/nginx_uml.png"><img src="https://github.com/bestia-dev/deploying_rust_server_and_database/raw/main/images/nginx_uml.png" alt="nginx uml" style="max-width: 100%;"></a></p>
<p dir="auto">In the file <code>/etc/nginx/sites-available/default</code> I append these config lines:</p>
<div class="highlight highlight-source-nginx notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="#region webpage_hit_counter
   # only complete route with trailing slash works
   # the trailing / after both of these lines means this route is not appended to the forwarding
   location /webpage_hit_counter/ {
      proxy_pass http://127.0.0.1:8011/webpage_hit_counter/;
      proxy_buffering off;
   }
#endregion webpage_hit_counter"><pre><span class="pl-c">#region webpage_hit_counter</span>
   <span class="pl-c"># only complete route with trailing slash works</span>
   <span class="pl-c"># the trailing / after both of these lines means this route is not appended to the forwarding</span>
   <span class="pl-k">location</span> <span class="pl-en">/webpage_hit_counter/ </span>{
      <span class="pl-k">proxy_pass</span> http://127.0.0.1:8011/webpage_hit_counter/;
      <span class="pl-k">proxy_buffering</span><span class="pl-c1"> off</span>;
   }
<span class="pl-c">#endregion webpage_hit_counter</span></pre></div>
<p dir="auto">Gracefully reload NGINX web server to read the modified config files:</p>
<div class="highlight highlight-source-shell notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="sudo systemctl reload nginx

#Try it in browser or with curl:
curl https://bestia.dev/webpage_hit_counter/get_svg_image/555555.svg"><pre>sudo systemctl reload nginx

<span class="pl-c"><span class="pl-c">#</span>Try it in browser or with curl:</span>
curl https://bestia.dev/webpage_hit_counter/get_svg_image/555555.svg</pre></div>
<p dir="auto">It works like a charm!</p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">My webpages and hit_counts</h2><a id="user-content-my-webpages-and-hit_counts" class="anchor" aria-label="Permalink: My webpages and hit_counts" href="#my-webpages-and-hit_counts"></a></div>
<p dir="auto">I already have a hit_counter on my web pages. I want to replace it with my project webpage_hit_counter.<br>
I will start with my webpage <code>bestia.dev</code> it has 273 hits.<br>
The old img element was like this:</p>
<div class="highlight highlight-text-html-basic notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="&lt;img src=&quot;https://hits.seeyoufarm.com/api/count/incr/badge.svg?url=https%3A%2F%2Fbestia.dev&amp;count_bg=%2379C83D&amp;title_bg=%23555555&amp;icon=&amp;icon_color=%23E7E7E7&amp;title=hits&amp;edge_flat=false&quot;/&gt;"><pre><span class="pl-kos">&lt;</span><span class="pl-ent">img</span> <span class="pl-c1">src</span>="<span class="pl-s">https://hits.seeyoufarm.com/api/count/incr/badge.svg?url=https%3A%2F%2Fbestia.dev&amp;count_bg=%2379C83D&amp;title_bg=%23555555&amp;icon=&amp;icon_color=%23E7E7E7&amp;title=hits&amp;edge_flat=false</span>"<span class="pl-kos">/&gt;</span></pre></div>
<p dir="auto">My new counter will have a random id number:</p>
<div class="highlight highlight-text-html-basic notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="&lt;img src=&quot;https://bestia.dev/webpage_hit_counter/get_svg_image/546994039.svg&quot;/&gt;"><pre><span class="pl-kos">&lt;</span><span class="pl-ent">img</span> <span class="pl-c1">src</span>="<span class="pl-s">https://bestia.dev/webpage_hit_counter/get_svg_image/546994039.svg</span>"<span class="pl-kos">/&gt;</span></pre></div>
<p dir="auto">Let's insert the data in the database:</p>
<div class="highlight highlight-source-shell notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="psql -h localhost -p 5432 -U admin -W -d webpage_hit_counter

insert into webpage(id, webpage) values(546994039, 'bestia.dev');

insert into hit_counter(webpage_id, count) values(546994039, 273);"><pre>psql -h localhost -p 5432 -U admin -W -d webpage_hit_counter

insert into webpage(id, webpage) values(546994039, <span class="pl-s"><span class="pl-pds">'</span>bestia.dev<span class="pl-pds">'</span></span>)<span class="pl-k">;</span>

insert into hit_counter(webpage_id, count) values(546994039, 273)<span class="pl-k">;</span></pre></div>
<p dir="auto">Check the bestia.dev page. It shows the hit_counter.<br>
Refresh it and it is incremented.<br>
Fantastic!<br>
I can now repeat this for all my other pages.</p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">Check all my hit counts</h2><a id="user-content-check-all-my-hit-counts" class="anchor" aria-label="Permalink: Check all my hit counts" href="#check-all-my-hit-counts"></a></div>
<p dir="auto">In psql I can now see the hit counters of all of my webpages.</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="select W.webpage, H.count from hit_counter H join webpage W on W.id=H.webpage_id order by H.count desc;"><pre lang="psql" class="notranslate"><code>select W.webpage, H.count from hit_counter H join webpage W on W.id=H.webpage_id order by H.count desc;
</code></pre></div>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">Open-source and free as a beer</h2><a id="user-content-open-source-and-free-as-a-beer" class="anchor" aria-label="Permalink: Open-source and free as a beer" href="#open-source-and-free-as-a-beer"></a></div>
<p dir="auto">My open-source projects are free as a beer (MIT license).<br>
I just love programming.<br>
But I need also to drink. If you find my projects and tutorials helpful, please buy me a beer by donating to my <a href="https://paypal.me/LucianoBestia" rel="nofollow">PayPal</a>.<br>
You know the price of a beer in your local bar ;-)<br>
So I can drink a free beer for your health :-)<br>
<a href="https://translate.google.com/?hl=en&amp;sl=sl&amp;tl=en&amp;text=Na%20zdravje&amp;op=translate" rel="nofollow">Na zdravje!</a> <a href="https://dictionary.cambridge.org/dictionary/italian-english/alla-salute" rel="nofollow">Alla salute!</a> <a href="https://dictionary.cambridge.org/dictionary/german-english/prost" rel="nofollow">Prost!</a> <a href="https://matadornetwork.com/nights/how-to-say-cheers-in-50-languages/" rel="nofollow">Nazdravlje!</a> 🍻</p>
<p dir="auto"><a href="https://bestia.dev" rel="nofollow">//bestia.dev</a><br>
<a href="https://github.com/bestia-dev">//github.com/bestia-dev</a><br>
<a href="https://bestiadev.substack.com" rel="nofollow">//bestiadev.substack.com</a><br>
<a href="https://youtube.com/@bestia-dev-tutorials" rel="nofollow">//youtube.com/@bestia-dev-tutorials</a></p>
</article>
</body>

</html>