<!DOCTYPE html>
<html>

<head>
    <title>cross_compile_crustde_container</title>
    <meta http-equiv="Content-type" content="text/html;charset=utf-8" />
    <meta name="Description" content="09. Cross-compile Rust to Linux, Windows, Musl container, WASI and WASM with OCI container (2023-05)">
    <meta name="author" content="https://github.com/bestia-dev">
    <meta name=viewport content="width=device-width, initial-scale=1">
    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico">
    <link rel="stylesheet" href="../css/normalize.css">
    <link rel="stylesheet" href="../css/bestia01.css">
</head>

<body>
    <header>
        <nav>
            <a href="https://bestia.dev/index.html">bestia.dev</a>
        </nav>
    </header>
    <div>&nbsp;</div> 
    <div class="small"><a id="navbar_brand" href="https://bestia.dev" style="justify-content: center;">
                <img src="https://bestia.dev/images/bestia_icon.png" alt="bestia.dev" title="bestia.dev" />
            </a>This is a copy of the Github readme. Find the original on <a href="https://github.com/CRUSTDE-ContainerizedRustDevEnv/cross_compile_crustde_container">https://github.com/CRUSTDE-ContainerizedRustDevEnv/cross_compile_crustde_container</a></div>

<article class="markdown-body entry-content container-lg" itemprop="text">
<div class="markdown-heading" dir="auto"><h1 tabindex="-1" class="heading-element" dir="auto">cross_compile_crustde_container</h1><a id="user-content-cross_compile_crustde_container" class="anchor" aria-label="Permalink: cross_compile_crustde_container" href="#cross_compile_crustde_container"></a></div>
<p dir="auto"><strong>09. Cross-compile Rust to Linux, Windows, Musl container, WASI and WASM with OCI container (2023-05)</strong><br>
<em><strong>version: 2024.326.1347  date: 2024-03-26 author: <a href="https://bestia.dev" rel="nofollow">bestia.dev</a> repository: <a href="https://github.com/CRUSTDE-ContainerizedRustDevEnv/cross_compile_crustde_container">GitHub</a></strong></em></p>
<p dir="auto"><a target="_blank" rel="noopener noreferrer nofollow" href="https://camo.githubusercontent.com/c273959e453b2eacb9b7719663be397499b129c79eb13180305a069b3c2f5e51/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f7475746f7269616c2d79656c6c6f77"><img src="https://img.shields.io/badge/tutorial-yellow" alt="status" style="max-width: 100%;"></a></p>
<p dir="auto"><a target="_blank" rel="noopener noreferrer nofollow" href="https://raw.githubusercontent.com/CRUSTDE-ContainerizedRustDevEnv/.github/main/images/crustde_250x250.png"><img src="https://raw.githubusercontent.com/CRUSTDE-ContainerizedRustDevEnv/.github/main/images/crustde_250x250.png" alt="logo" style="max-width: 100%;"></a><br>
cross_compile_crustde_container is a member of the <a href="https://github.com/orgs/CRUSTDE-ContainerizedRustDevEnv/repositories?q=sort%3Aname-asc">CRUSTDE-ContainerizedRustDevEnv</a> project.</p>
<p dir="auto"><a href="https://github.com/CRUSTDE-ContainerizedRustDevEnv/cross_compile_crustde_container/"><img src="https://img.shields.io/badge/Lines_in_markdown-239-green.svg" alt="Lines in md" style="max-width: 100%;"></a></p>
<p dir="auto"><a href="https://github.com/CRUSTDE-ContainerizedRustDevEnv/cross_compile_crustde_container/blob/master/LICENSE"><img src="https://img.shields.io/badge/license-MIT-blue.svg" alt="License" style="max-width: 100%;"></a>
<a target="_blank" rel="noopener noreferrer nofollow" href="https://camo.githubusercontent.com/1d101f1f1f7c2e782b5be9ee54b15583099005bd2921a86a49f65ff045dff517/68747470733a2f2f6265737469612e6465762f776562706167655f6869745f636f756e7465722f6765745f7376675f696d6167652f313033313637343432352e737667"><img src="https://bestia.dev/webpage_hit_counter/get_svg_image/1031674425.svg" alt="cross_compile_crustde_container" style="max-width: 100%;"></a></p>
<p dir="auto">Hashtags: #rustlang #buildtool #developmenttool #tutorial #docker #ssh #container #podman #Linux #OCI<br>
My projects on GitHub are more like a tutorial than a finished product: <a href="https://github.com/bestia-dev/tutorials_rust_wasm">bestia-dev tutorials</a>.</p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">Intro</h2><a id="user-content-intro" class="anchor" aria-label="Permalink: Intro" href="#intro"></a></div>
<p dir="auto">Welcome to bestia.dev !<br>
Learning Rust and Wasm programming and having fun.<br>
I just love programming !</p>
<p dir="auto">I upgraded my Containerized Rust Development Environment (CRUSTDE) to enable cross-compilation to Linux, Windows, musl, WASI and WASM.<br>
Let's make a short tutorial on how it works!</p>
<p dir="auto">This project has also a youtube video tutorial. Watch it:</p>

<p dir="auto"><a href="https://bestia.dev/youtube/cross_compile_crustde_container.html" rel="nofollow"><img src="https://bestia.dev/youtube/cross_compile_crustde_container.jpg?_" width="400px" style="max-width: 100%;"></a></p>

<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">But it works on my machine!</h2><a id="user-content-but-it-works-on-my-machine" class="anchor" aria-label="Permalink: But it works on my machine!" href="#but-it-works-on-my-machine"></a></div>
<p dir="auto">It is smart to start the development from scratch from time to time to avoid accumulating side effects that we forget about. Then the problem "But it works on my machine!" arises. It is very easy to reset everything because we use containers and virtual machines.</p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">Install Debian in WSL2 on Windows</h2><a id="user-content-install-debian-in-wsl2-on-windows" class="anchor" aria-label="Permalink: Install Debian in WSL2 on Windows" href="#install-debian-in-wsl2-on-windows"></a></div>
<p dir="auto">We will start on Win10 with enabled WSL2.<br>
If exists, remove the Debian distro. Be careful to not lose any precious data!<br>
We will install a fresh Debian distro in Powershell. It takes a minute.</p>
<div class="highlight highlight-source-powershell notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="wsl --unregister Debian
wsl --install Debian"><pre>wsl <span class="pl-k">--</span>unregister Debian
wsl <span class="pl-k">--</span>install Debian</pre></div>
<p dir="auto">Open Debian bash, update and upgrade, then install curl and OpenSSH.</p>
<div class="highlight highlight-source-shell notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="cat /etc/debian_version;
   11.6
sudo apt update;
sudo apt upgrade;
cat /etc/debian_version;
   11.7
sudo apt install -y curl;
sudo apt install -y openssh-client;"><pre>cat /etc/debian_version<span class="pl-k">;</span>
   11.6
sudo apt update<span class="pl-k">;</span>
sudo apt upgrade<span class="pl-k">;</span>
cat /etc/debian_version<span class="pl-k">;</span>
   11.7
sudo apt install -y curl<span class="pl-k">;</span>
sudo apt install -y openssh-client<span class="pl-k">;</span></pre></div>
<p dir="auto">Just for info: Instead of the classic ctrl+c and ctrl+v, to Copy and Paste inside the bash terminal I use ctrl+shift+c and ctrl+shift+v.<br>
Cumbersome, but similar.</p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">Download and run the first bash script</h2><a id="user-content-download-and-run-the-first-bash-script" class="anchor" aria-label="Permalink: Download and run the first bash script" href="#download-and-run-the-first-bash-script"></a></div>
<p dir="auto">Make a directory, go inside and download the first script.</p>
<div class="highlight highlight-source-shell notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="mkdir -p ~/rustprojects/crustde_install;
cd ~/rustprojects/crustde_install;
curl -Sf -L https://github.com/CRUSTDE-ContainerizedRustDevEnv/crustde_cnt_img_pod/raw/main/crustde_install/download_scripts.sh --output download_scripts.sh;
# You can read the bash script, it only creates the directory structure, downloads scripts and suggests what script to run next.
clear;
cat download_scripts.sh;
clear;
sh download_scripts.sh;
# Read and follow the detailed instructions after every script."><pre>mkdir -p <span class="pl-k">~</span>/rustprojects/crustde_install<span class="pl-k">;</span>
<span class="pl-c1">cd</span> <span class="pl-k">~</span>/rustprojects/crustde_install<span class="pl-k">;</span>
curl -Sf -L https://github.com/CRUSTDE-ContainerizedRustDevEnv/crustde_cnt_img_pod/raw/main/crustde_install/download_scripts.sh --output download_scripts.sh<span class="pl-k">;</span>
<span class="pl-c"><span class="pl-c">#</span> You can read the bash script, it only creates the directory structure, downloads scripts and suggests what script to run next.</span>
clear<span class="pl-k">;</span>
cat download_scripts.sh<span class="pl-k">;</span>
clear<span class="pl-k">;</span>
sh download_scripts.sh<span class="pl-k">;</span>
<span class="pl-c"><span class="pl-c">#</span> Read and follow the detailed instructions after every script.</span></pre></div>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">Import SSH keys and personal data</h2><a id="user-content-import-ssh-keys-and-personal-data" class="anchor" aria-label="Permalink: Import SSH keys and personal data" href="#import-ssh-keys-and-personal-data"></a></div>
<p dir="auto">Inside the ssh directory, you will need 2 keys, one to access Github and the second to access your web server virtual machine.
You should already have these keys somewhere and you just need to copy them into the ssh folder.
I will call these keys github_com_bestia_dev_git_ssh_1 and bestia_dev_luciano_bestia_ssh_1, but you can have other names.
Modify accordingly to your locations and run these commands.</p>
<p dir="auto">Now you can run the first script with 4 parameters.
Change the parameters with your personal data. They are needed for the container.
The files will be stored in the ssh directory for later use.<br>
Then follow the instructions from the next script.</p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">Install Podman and create crustde_pod</h2><a id="user-content-install-podman-and-create-crustde_pod" class="anchor" aria-label="Permalink: Install Podman and create crustde_pod" href="#install-podman-and-create-crustde_pod"></a></div>
<p dir="auto">Now you can install Podman and set up the keys crustde_pod_keys.
Give a passphrase to the ssh keys and remember it, you will need it.</p>
<p dir="auto">When installing Podman and the setup will finish, you can create the pod crustde_pod.
On the first run, it will download around 1.2 GB from DockerHub and store it in the cache for later use.
After that, follow the detailed instructions.</p>
<p dir="auto">The bash script will create the crustde_pod.
It contains Rust, cargo, rustc and VSCode development environment.
All outbound network traffic from the container is restricted through the Squid firewall proxy.</p>
<p dir="auto">To start this 'pod' it is mandatory to run the bash script crustde_pod_after_reboot.</p>
<div class="highlight highlight-source-shell notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="sh ~/rustprojects/crustde_install/crustde_pod_after_reboot.sh"><pre>sh <span class="pl-k">~</span>/rustprojects/crustde_install/crustde_pod_after_reboot.sh</pre></div>
<p dir="auto">Be sure to push your code to GitHub frequently because sometimes containers just stop working.</p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">VSCode</h2><a id="user-content-vscode" class="anchor" aria-label="Permalink: VSCode" href="#vscode"></a></div>
<p dir="auto">You can open VSCode directly on an existing project inside the container from the Linux host bash terminal.</p>
<div class="highlight highlight-source-shell notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="code --remote ssh-remote+crustde_vscode_cnt /home/rustdevuser/rustprojects "><pre>code --remote ssh-remote+crustde_vscode_cnt /home/rustdevuser/rustprojects </pre></div>
<p dir="auto">The fresh empty container works perfectly!</p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">Compile to standard Linux executable (dynamically linked to glibc)</h2><a id="user-content-compile-to-standard-linux-executable-dynamically-linked-to-glibc" class="anchor" aria-label="Permalink: Compile to standard Linux executable (dynamically linked to glibc)" href="#compile-to-standard-linux-executable-dynamically-linked-to-glibc"></a></div>
<p dir="auto">We will now create a new simple rust project as a proof-of-concept.<br>
We can compile it for Linux right away.</p>
<div class="highlight highlight-source-shell notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="cargo auto build
./target/debug/rust_hello upper world"><pre>cargo auto build
./target/debug/rust_hello upper world</pre></div>
<p dir="auto">Nothing new here. It works like a charm!</p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">Cross-compile for Windows</h2><a id="user-content-cross-compile-for-windows" class="anchor" aria-label="Permalink: Cross-compile for Windows" href="#cross-compile-for-windows"></a></div>
<p dir="auto">Now cross-compile to Windows. Just add the correct target option.
If we need to do this frequently, add it to the automation tasks.</p>
<div class="highlight highlight-source-shell notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="cargo build --target x86_64-pc-windows-gnu"><pre>cargo build --target x86_64-pc-windows-gnu</pre></div>
<p dir="auto">We are connected over ssh and we can download the exe file to Windows.
On Windows, we can run the CLI in Powershell and it works!</p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">Compile to standalone Linux executable with Musl</h2><a id="user-content-compile-to-standalone-linux-executable-with-musl" class="anchor" aria-label="Permalink: Compile to standalone Linux executable with Musl" href="#compile-to-standalone-linux-executable-with-musl"></a></div>
<p dir="auto">If we want to compile and build a true standalone executable for Linux we need to explicitly use the Musl target and statically link to the Musl library.<br>
That makes it perfect to run inside a scratch Linux OCI container without any dependencies.</p>
<div class="highlight highlight-source-shell notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="cargo build --target x86_64-unknown-linux-musl"><pre>cargo build --target x86_64-unknown-linux-musl</pre></div>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">Create an "application" container from scratch</h2><a id="user-content-create-an-application-container-from-scratch" class="anchor" aria-label="Permalink: Create an &quot;application&quot; container from scratch" href="#create-an-application-container-from-scratch"></a></div>
<p dir="auto">We will download the binary (from VSCode to Windows) and move it to the Debian in WSL where we will use Buildah to create a Linux Container image from scratch.
Using Buildah is very simple. We can run commands step by step and check things in between.
Later we can put these commands inside a bash script and it works perfectly.</p>
<div class="highlight highlight-source-shell notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="buildah from \
--name scratch_hello_world_img \
scratch

buildah config \
--author=github.com/bestia-dev \
--label name=scratch_hello_world_img \
--label source=github.com/CRUSTDE-ContainerizedRustDevEnv/crustde_cnt_img_pod \
scratch_hello_world_img

buildah copy scratch_hello_world_img  ~/rustprojects/rust_hello/musl/rust_hello /rust_hello

buildah commit scratch_hello_world_img docker.io/bestiadev/scratch_hello_world_img

# now run the container and executable

podman run scratch_hello_world_img /rust_hello
podman run scratch_hello_world_img /rust_hello upper world"><pre>buildah from \
--name scratch_hello_world_img \
scratch

buildah config \
--author=github.com/bestia-dev \
--label name=scratch_hello_world_img \
--label source=github.com/CRUSTDE-ContainerizedRustDevEnv/crustde_cnt_img_pod \
scratch_hello_world_img

buildah copy scratch_hello_world_img  <span class="pl-k">~</span>/rustprojects/rust_hello/musl/rust_hello /rust_hello

buildah commit scratch_hello_world_img docker.io/bestiadev/scratch_hello_world_img

<span class="pl-c"><span class="pl-c">#</span> now run the container and executable</span>

podman run scratch_hello_world_img /rust_hello
podman run scratch_hello_world_img /rust_hello upper world</pre></div>
<p dir="auto">Then I use Podman to run the container. It works!</p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">Cross-compile to WASI</h2><a id="user-content-cross-compile-to-wasi" class="anchor" aria-label="Permalink: Cross-compile to WASI" href="#cross-compile-to-wasi"></a></div>
<p dir="auto">I will compile for the target wasi now and run it with the wasmtime wasi runtime.</p>
<div class="highlight highlight-source-shell notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="cargo build --target wasm32-wasi
wasmtime ./target/wasm32-wasi/debug/rust_hello.wasm upper world"><pre>cargo build --target wasm32-wasi
wasmtime ./target/wasm32-wasi/debug/rust_hello.wasm upper world</pre></div>
<p dir="auto">Everything works!</p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">Cross-compile to WASM in-browser</h2><a id="user-content-cross-compile-to-wasm-in-browser" class="anchor" aria-label="Permalink: Cross-compile to WASM in-browser" href="#cross-compile-to-wasm-in-browser"></a></div>
<p dir="auto">WASM runs inside a browser as a library and I cannot use the exact CLI project.
I need just a few adjustments because of the user interface.</p>
<p dir="auto">I will use the 'cargo auto new_wasm' command to create a simple yet fully functional wasm program inside the browser.</p>
<div class="highlight highlight-source-shell notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="cargo auto new_wasm rust_wasm_hello
cargo auto build
basic-http-server -a 0.0.0.0:4000 ./web_server_folder
https://localhost:4000/rust_wasm_hello#upper/world"><pre>cargo auto new_wasm rust_wasm_hello
cargo auto build
basic-http-server -a 0.0.0.0:4000 ./web_server_folder
https://localhost:4000/rust_wasm_hello#upper/world</pre></div>
<p dir="auto">On purpose, the project is made very similar to the CLI we already know. It reads 2 arguments from the URL local hash fragment and interprets it in the same way as the CLI.<br>
I then use the exact same Rust code for the project logic except for the user interface. The User interface is different and it is smart to isolate it in separate modules. So the logic can be reused.<br>
The structure of the modules in the wasm project is made similar as possible to the CLI. There are some minor differences though.<br>
The wasm program needs a basic web server and it then runs entirely inside the browser.</p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">Outro</h2><a id="user-content-outro" class="anchor" aria-label="Permalink: Outro" href="#outro"></a></div>
<p dir="auto">We have seen live how cross-compiling works inside the Containerized Rust Development environment. It works nicely!<br>
This is all for today. Thank you for watching and see you next time.<br>
Find my code and tutorials on bestia.dev or GitHub.</p>
<div class="markdown-heading" dir="auto"><h2 tabindex="-1" class="heading-element" dir="auto">Open-source and free as a beer</h2><a id="user-content-open-source-and-free-as-a-beer" class="anchor" aria-label="Permalink: Open-source and free as a beer" href="#open-source-and-free-as-a-beer"></a></div>
<p dir="auto">My open-source projects are free as a beer (MIT license).<br>
I just love programming.<br>
But I need also to drink. If you find my projects and tutorials helpful, please buy me a beer by donating to my <a href="https://paypal.me/LucianoBestia" rel="nofollow">PayPal</a>.<br>
You know the price of a beer in your local bar ;-)<br>
So I can drink a free beer for your health :-)<br>
<a href="https://translate.google.com/?hl=en&amp;sl=sl&amp;tl=en&amp;text=Na%20zdravje&amp;op=translate" rel="nofollow">Na zdravje!</a> <a href="https://dictionary.cambridge.org/dictionary/italian-english/alla-salute" rel="nofollow">Alla salute!</a> <a href="https://dictionary.cambridge.org/dictionary/german-english/prost" rel="nofollow">Prost!</a> <a href="https://matadornetwork.com/nights/how-to-say-cheers-in-50-languages/" rel="nofollow">Nazdravlje!</a> 🍻</p>
<p dir="auto"><a href="https://bestia.dev" rel="nofollow">//bestia.dev</a><br>
<a href="https://github.com/bestia-dev">//github.com/bestia-dev</a><br>
<a href="https://bestiadev.substack.com" rel="nofollow">//bestiadev.substack.com</a><br>
<a href="https://youtube.com/@bestia-dev-tutorials" rel="nofollow">//youtube.com/@bestia-dev-tutorials</a></p>
</article>
</body>

</html>